This appears to match what you were looking for: your treatment is randomized initially and people drop out non-randomly. 

$\newcommand{\R}{\mathbb{R}} \newcommand{\N}{\mathbb{N}} \newcommand{\F}{\mathbb{F}} \newcommand{\C}{\mathbb{C}} \newcommand{\E}{\mathbb{E}} %short command for inseting abbreviated "such that" in a math environment \newcommand{\st}{\text{ s.t. }} %text in a math environment "as" \newcommand{\as}{\text{ as }} %various referencing commands \newcommand{\rref}[1]{(\ref{#1})} \newcommand{\eref}[1]{eq. (\ref{#1})} \newcommand{\fref}[1]{Figure \ref{#1}} %differential d \newcommand{\dd}{\, \mathrm{d}} %variance and covariance$ Part 1 Yes. However, it is useful to simplify the answer even further and to write optimal consumption in terms of other. more easily observed quantities. Here's the derivation. I also solve for the portfolio holdings. Calculating Optimal Consumption in terms of Wealth Start again with some preliminary calculations related to the budget constraint. \begin{align*} \mathbb E_t \left [\pi_T^{\frac{\gamma - 1}{\gamma}} \right ] &= \mathbb E_0 \pi_t^{\frac{\gamma-1}{\gamma}} \exp \left \{ - \frac{\gamma - 1}{\gamma} \left (r + \frac 12 \eta^2 \right ) (T-t) - \frac{\gamma - 1}{\gamma} \eta (B(T) - B(t)) \right \} \\ &= \pi_t^{\frac{\gamma-1}{\gamma}} \exp \left \{ - \frac{\gamma - 1}{\gamma} (r + \frac 12 \eta^2 ) (T-t) + \frac 12 \frac{(\gamma - 1)^2}{\gamma^2} \eta^2 (T-t) \right \} \\ &= \pi_t^{\frac{\gamma-1}{\gamma}} \exp \left \{ (T-t) \frac{\gamma - 1}{\gamma} \left[ - r + \frac 12 \eta^2 \frac{1}{\gamma} \right] \right \}. \end{align*} From the budget constraint \begin{align*} \pi_t W_t &= \E_t \left[\int_t^\infty \pi_s C_s \dd s\right] \\ W_t &= \frac{1}{\pi_t} \E_t\left[\int_t^\infty \lambda^{-1/\gamma} e^{-\frac{\rho}{\gamma} s} \pi_s^{\frac{\gamma-1}{\gamma}} \dd s\right] \\ &= \frac{1}{\pi_t} \int_t^\infty \lambda^{-1/\gamma} e^{-\frac{\rho}{\gamma} s} \E_t\left[\pi_s^{\frac{\gamma-1}{\gamma}} \right] \dd s \\ &= \frac{1}{\pi_t} \int_t^\infty \lambda^{-1/\gamma} e^{-\frac{\rho}{\gamma} s} \pi_t^{\frac{\gamma-1}{\gamma}} \exp\{-(s-t) \frac{\gamma-1}{\gamma} \left[r + \frac 12 \eta^2 \frac 1 \gamma \right]\} \dd s \\ &= \pi^{\frac{-1}{\gamma}} \lambda^{\frac{-1}{\gamma}} \int_t^\infty \exp\left\{ -\frac{\rho}{\gamma} (s-t) - \frac{\rho}{\gamma} t - (s-t) \frac{\gamma-1}{\gamma} \left[r + \frac 12 \eta^2 \frac 1 \gamma \right]\right\} \dd s\\ &= \pi^{\frac{-1}{\gamma}} \lambda^{\frac{-1}{\gamma}} e^{-\frac \rho \gamma t} \int_t^\infty \exp\left\{ - (s-t) \frac{\gamma-1}{\gamma} \left[r + \frac{\rho}{\gamma-1} + \frac 12 \eta^2 \frac 1 \gamma \right]\right\} \dd s \\ &= \pi^{\frac{-1}{\gamma}} \lambda^{\frac{-1}{\gamma}} e^{-\frac \rho \gamma t} \frac 1 a, \end{align*} where $a = \frac{\gamma-1}{\gamma} \left[r + \frac{\rho}{\gamma-1} + \frac 12 \eta^2 \frac 1 \gamma\right]$ (this is the same as defined in attempt demonstrated in the question). From our derivation of optimal consumption, we have $$ C_t^* = \lambda^{-\frac 1 \gamma }e^{-\frac \rho \gamma t} \pi_t^{-\frac 1 \gamma} = a W_t. $$ Deriving the dynamics for optimal consumption: $\dd C_t^*$. To proceed to find the optimal portfolio to support this level of consumption, we need to compute the dynamics of $C_t^*$. We will show that, from our derivation of optimal consumption, \begin{equation} \dd W_t = \frac 1 a \dd C_t^* = \frac 1 a C_t \frac 1 \gamma \left( \eta \dd Z_t + \frac 12 \frac{1+\gamma}{\gamma} \eta^2 \dd t\right). \label{wealth-dynamics-from-optimal-consumption} \tag 1 \end{equation} The second equality is derived as follows. That second equality comes from $\lambda^{-\frac 1 \gamma} = \frac {w a} r$ (derived in the attempt given in the question statement) and from Ito's lemma applied to \begin{align*} C^*_t &= \lambda^{-\frac 1 \gamma }e^{-\frac \rho \gamma t} \pi_t^{-\frac 1 \gamma} \\ &= \frac {w a}{r} (e^{\rho t} \pi_t)^{-\frac 1 \gamma} \\ &= \frac {w a}{r} \xi_t^{-\frac 1 \gamma}. \end{align*} Here I have added the simplifying assumption that $\rho = r$ and I have used the definition that $\pi_t = e^{-r t} \xi_t$. The calculation of Ito's lemma on optimal consumption proceeds like this: \begin{align*} \dd C_t &= - \frac {wa}{r} \frac 1 \gamma \xi_t^{\frac{-1 - \gamma}{\gamma}} \dd \xi_t + \frac 12 \frac{wa}{r} \frac 1 \gamma \frac{1 + \gamma}{\gamma} \xi_t^{- \frac 1 \gamma - 2} (\dd \xi_t)^2 \\ &= - C_t \frac 1 \gamma \left( \frac{\dd \xi_t}{\xi_t} \right) + \frac 12 C_t \frac 1 \gamma \frac{1+\gamma}{\gamma} \left( \frac{\dd \xi_t}{\xi_t}\right)^2 \\ &= -C_t \frac 1 \gamma (-\eta \dd B_t) + \frac 12 C_t \frac 1 \gamma \frac{1+\gamma}{\gamma} ( \eta^2 \dd t) \end{align*} Thus, $$ \frac{ \dd C_t}{C_t} = \frac 1 \gamma \left( \frac 12 \eta^2 \frac{1+\gamma}\gamma \dd t + \eta \dd B_t \right). $$ Match terms to derive optimal portfolio. We can deduce the optimal portfolio be deriving the dynamics of a portfolio with a trading strategy defined by the weight $\omega_t$ and comparing these dynamics to the dynamics of wealth implied by the dynamics we calculated for optimal consumption. If $\omega$ is the fraction of wealth we invest in the risky security and $1-\omega$ is the fraction invested in the riskless security, then the dynamics for wealth can be written $$ \dd W_t = \omega (\mu -r) W_t \dd t + (r W_t - C_t) \dd t + W_t \omega \sigma \dd Z_t. $$ Now, we can derive an expression for $\omega$ by matching the terms of this equation with the terms of equation (\ref{wealth-dynamics-from-optimal-consumption}). From the terms on $\dd Z_t$, \begin{align*} W_t \omega \sigma &= \frac 1 a C_t \frac 1 \gamma \eta \\ \omega &= \frac \eta {\sigma \gamma}. \end{align*} Part 2 It seems like consumption is stochastic because consumption here is stochastic. Consumption depends on the state of the economy. It is, however, $\mathcal F_t$-measurable, so optimal consumption at time $t$ depends only on information available at time $t$. Because of the positive Sharpe ratio $\eta$ and finite risk aversion, the agent will invest in the risky security. As we showed previously, consumption is a fraction of wealth, $C_t^* = a W_t$. Wealth depends on the performance of the agent's investments. In good times, the agent consumes more. The fraction of wealth consumed, $a$, depends on the interest rate $r$, subjective discounting $\rho$, risk aversion $\gamma$, and the market price of risk (Sharpe ratio) $\eta$. Part 3 One way this can occur is if we assume that the agent can only invest in the riskless security. Just as well, let $\eta = 0$. Also, suppose that the interest rate is equal to the subjective discount rate, $r = \rho$. Doing this, we see that $\pi_t = \exp\{-r t\}$. Also, from the budget constraint we know that wealth is $$ W_t = B_t + \theta_t S_t + \E_t \frac{1}{\pi_t} \int_t^\infty \pi_s w \dd s = B_t + \theta_t S_t + \frac w r, $$ where $B_t$ is the amount on money invested in the riskless asset, $\theta_t$ is the dollar amount invested in the risky security $S_t$, and the remaining term is the expected discounted present value of future wages (the expectation here could have been left out since $\pi_s$ and $w$ are constant in this case, but I've included it for consistency). Also, since $\eta = 0$, $a = r$. Thus, $$ C_t^* = r W_t = r \left( B_t + \frac w r\right). $$ Since $B_0 = 0$ by assumption, $C_0 = w$. Loosely speaking, an induction-like argument gives us that $B_t = 0$ for all $t$ and, thus, $$ C_t^* = \frac w r = w. $$ 

As I understand it, the best way to answer your question is to translate your description in to the language of economics and to understand the way that economists talk about these things. To put this in to the language of economics, these would likely be "durable goods" with very low rates of depreciation. "Capital goods" (or just, capital) are a type of durable good. It is usually assumed that all durable good depreciate at least at some positive rate. This isn't a terrible assumption as, in your example, a hammer might rust over time---even if that time period is very, very long. 

Question How should I deal with missing data when trying to test the CAPM? Specifically, there are some stocks that are newly listed and/or delisted at any time. I don't want to exclude assets for which I don't have complete data because this would create a kind of survivor bias. I know that CRSP provides delisting returns that should, but how do I manage the missing data in practice? For example, in the unconstrained model, the procedure looks like this: 

Why assume constant rates in the example in Hayashi? I think it's just an assumption made in that particular example. If you read a little further into the linked chapter, you'll see that Fama discusses 4 different models of market equilibrium. The first two are ridiculous, but he's doing it just to demonstrate the concept. (Part of the reason is that some of the previous ideas about market efficiency had some bizarre consequences, which he demonstrates through those examples.) The point is that any test of market efficiency is always tied to the model that is assumed. If the test fails, you know one of two things: either the market is inefficient or your model of the market is wrong. The unfortunate truth, however, is that you will never know which one it is. 

I've heard that there is a lot of work being done recently that applies Epstein-Zin preferences. The Wikipedia page doesn't seem to be very full. 

The key take-away from this is that the EMH is about information. But it doesn't tell use about the way the market uses that information to determine prices (of $n$ assets $p_1, ..., p_n$). The behavior is given by $f_m$, which we have not specified. The assumption of a random walk in prices is, in part, as assumption about $f_m$. It is not so much an assumption about $I^m_{t-1}$. To get to something resembling the random walk theory, we need to add assumptions about the market being competitive. 3. Is there a difference between a price "reflecting all information" and "containing all information"? Sure, this is a somewhat arbitrary semantic difference. Nonetheless, I think that there is an important point to be made here. So let's try to be a little more formal with it. Let's take a look a version the random walk hypothesis. Consider the model $$ p_t = d + p_{t-1} + \epsilon_{t}, $$ where $d$ is a fixed drift rate and $\epsilon_t$ is a sequence of mean zero iid shocks. I believe that it is a common mistake to claim that the EMH implies that $p_{t-1}$ "contains all available information." Why? Because this claim seems to imply that the information set $I_{t-1}$ can be spanned by (or generated by) the single variable $p_{t-1}$. However, as we discussed in the previous sections, the EMH does not make this claim. Instead, the EMH makes the claim that the price $p_{t-1}$ "reflects all information" in the sense that the behavior of prices is determined by $f_m$ conditioned on $I_{t-1}$. That is, the distribution of $n$ assets over the next period is $f_m(p_1,..., p_n | I^m_{t-1})$. With this in mind, it seems clear and likely in many situations that for most random variables $X_t$, including future prices, $$ E[X_t | p_{t-1}] \neq E[X_t | I_{t-1}^m]. $$ However, this ultimately depends, again, on how the market uses the information to form prices, as encoded in $f_m$. It very well may be that under some assumptions about $f_m$ that $$ E[p_t | p_{t-1}] = E[p_t | I_{t-1}^m]. $$ 4. What about the point that expectations conditional on all available information is the best predictor (in the sense on minimizing mean squared errors)? Suppose the market were to compute the conditional expectation of tomorrows prices based on all available information. Then we could write that $p_t = E[p_t | I^m_{t-1}] + u_t$, where $E[u_t | I^m_{t-1}] = 0$. If we assume the EMH, then $I_{t-1} = I^m_{t-1}$ and thus $E[u_t | I_{t-1}] = 0$ as well. This is true. However, this shouldn't be taken to mean that (1) any one person has all the information of the market necessary to make this calculation or (2) that this implies anything about the behavior of prices in the market. This is simply a calculation of a conditional expected value. On the first point (1), recall that the EMH, like the assumption of Rational Expectations , is an assumption about aggregates. From Wikipedia, it assumes "that on average the population is correct (even if no one person is). The markets are a machine that aggregates individual's incomplete information and produces something that reflects all information. See also this answer about Rational Expectations. On the second point (2), the calculation of this conditional expectation is just that. A calculation. It doesn't say anything about how the market behaves or what it will do with this calculation. This behavior is encoded in $f_m$. 5. The random walk hypothesis does show up under the assumption of competitive markets (e.g., no arbitrage). If we assume that there is no arbitrage (type 1 and type 2), this implies the existence of a strictly positive stochastic discount factor $\{\Lambda_t\}$ (state prices). Together with the EMH, we get $$ \Lambda_t p_t = E\left[ \sum_{\tau=t+1}^\infty \Lambda_\tau d_\tau | I_t \right]. $$ We can rewrite this as $$ \Lambda_t p_t = E[\Lambda_{t+1}(p_{t+1} + d_{t+1})| I_t]. $$ That is, discounted price changes, after correction for dividends are unpredictable. Note, however, that this leaves the door open for the possibility that prices or returns themselves can be predictable. And, as a matter of fact, returns do seem to be predictable to substantial degree at business cycle frequencies. See the paper "Discount Rates," by John Cochrane. (Click here for the YouTube presentation cued to the right spot.) However, under these assumptions, discounted price changes, after correction for dividends cannot be predicted. 6. Under the Efficient Markets Hypothesis and the assumption of no arbitrage, can changes in the stock price be predictable? As we discussed, discounted price changes, after correction for dividends are unpredictable under these assumptions. However, it is still possible for returns to be predictable. I'm going to leave most of this discussion to the following three YouTube videos by John Cochrane (from his former Coursera course): 

Edit: Sometimes you'll see notation like this: $$ Pr( i \rightarrow k) = \Pr(\max(Y_{i,1}^{\ast},Y_{i,2}^{\ast},\ldots,Y_{i,K}^{\ast})=Y_{i,k}^{*}), $$ where $i \rightarrow k$ means that individual $i$ chooses choice $k$, is fairly concise once the appropriate notation is defined. If you're looking for a useful way to put this into a likelihood function, you might see something like this: $$ P_i = \prod_{k=1}^K Pr( i \rightarrow k)^{\mathbb 1_{i \rightarrow k}}, $$ where $\mathbb 1_{i \rightarrow k}$ is an indicator function that is equal to 1 when $i$ chooses choice $k$ and zero otherwise and $P_i$ is the PMF of the observation associated with individual $i$. Edit 2: For an explicit formula, see the same Wikipedia article. Check out, for instance, the section with the following: 

What resources are available for learning Dynare? I think it'd be nice to put together a list of resources that available to those new to Dynare. I've had a little experience with it but it'd be nice to know what resources I might be able to go to for questions on the beginner/intermediate level. Also, I would prioritize resources that have full-fledged examples. Does anybody have any suggestions?